# 3.2 Yaml 또는 JSON 디스크립터로 파드 생성

생성일: 2021년 3월 19일 오후 6:55

쿠버네티스 리소스 → REST API 엔드포인트에 JSON, YAML MENIFEST를 전송해 생성

(또는 `kubectl run` 으로 리소스를 만듦. [https://kubernetes.io/docs/reference/](https://kubernetes.io/docs/reference/) 참고)

## 1. 기존 파드의 YAML 디스크립터 살펴보기

파드의 정의 보기

(파드 이름은 `kube get po` 하면, 목록 볼 수 있음)

```bash
kubectl get po <파드이름> -o yaml
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.31.52.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.31.52.png)

(runtime 데이터가 포함되어있다)

### 파드를 정의하는 주요 부분

- Metadata: 이름, 네임스페이스, 레이블 및 파드에 관한 기타 정보 포함
- Spec: 파드 컨테이너, 볼륨, 기타 데이터  → 파드 자체에 관한 실제 명세를 가짐
- Status : 파드 상태, 각 컨테이너 설명과 상태, 파드 내부 IP, 기타 기본 정보 등 현재 실행 중인 파드에 관한 현재 정보를 포함

## 2. 파드를 정의하는 간단한 YAML 정의 작성하기

- kubia-manual.yaml 파일 생성

```bash
apiVersion: v1 //디스크립터는 쿠버네티스 API 버젼 v1d을 준수
kind: Pod //오브젝트 종류가 파드
metadata:
	name: kubia-manual //파드이름
spec:
	containers:
	- image: superjisonic/kubia //컨테이너를 만드는 컨테이너 이미지
		name : kubia //컨테이너 이름
		ports :
		- containerPort: 8080
			protocol: TCP //애플리케이션이 수신하는 포트
```

### 컨테이너 포트 지정

포트 정의를 하지 않아도 다른 클라이언트에서 포트를 통해 파드에 연결 가능함

- 컨테이너 : 0.0.0.0 주소에 열어 둔 포트를 통해 접속을 허용할 경우 파드 스펙에 포트를 명시적으로 나열하지 않아도 다른 파드에서 항상 해당 파드에 접속 가능

BUT, **포트를 명시적으로 정의**한다면
클러스터를 사용하는 모든 사람이 파드에서 노출한 포트를 빠르게 볼 수 있다

- kubectl explain : 사용 가능한 API 오브젝트 필드 찾기
    - https://kubernetes.io/docs/concepts/overview/kubernetes-api/
    - 여기서 레퍼런스 참조

```bash
kubectl explain pods
kubectl explain pod.spec
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.45.47.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.45.47.png)

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.46.18.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__2.46.18.png)

## 3. kubectl create 명령으로 파드 만들기

YAML 파일로 파드 만들기. (create -f 명령은 YAML, JSON으로 리소스 만드는데 사용)

```bash
kubectl create -f kubia-manual.yaml
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.13.43.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.13.43.png)

vi 로 yaml 만들때 indentation에 진짜 주의하자,... 여러 에러를 맛볼 수 있다

```bash
apiVersion: v1
kind: Pod
metadata:
    name: kubia-manual
spec:
    containers:
    - image: superjisonic/kubia
      name: kubia
      ports:
      - containerPort: 8080
        protocol: TCP
```

꼭.. 이 인덴테이션을 지키도록,,, (흑흑)

### 실행중인 파드의 전체 정의 가져오기

파드를 만든 뒤 쿠버네티스에 파드의 전체 yaml을 요청해서 봐보자

```bash
kubectl get po kubia-manual -o yaml
kubectl get po kubia-manual -o json/
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.17.13.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.17.13.png)

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.17.58.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.17.58.png)

### 파드 목록에서 새로 생성된 파드 보기

```bash
kubectl get pods
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.18.54.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.18.54.png)

kubia-manual이 실행중인것을 확인 가능

## 4. 애플리케이션 로그 보기

예제를 통해 구현했던 node.js 애플리케이션 ⇒ 로그를 프로세스의 표준 출력에 기록

- 컨테이너화된 앱은 로그를 파일에 쓰기보다는 표준 출력과 표준 에러에 로그를 남기는 게 일반적임
- 컨테이너 런타임(=도커)은 이러한 스트림 파일로 전달하고, 다음 명령을 이용해 컨테이너 로그를 가져옴

```bash
docker logs <container id>
```

ssh로 파드가 실행중인 노드에 접속해 docker logs 명령으로 로그 가져올 수 있음

### kubectl logs를 이용해 파드 로그 가져오기

```bash
kubectl logs kubia-manual
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled.png)

어떠한 웹 요청도 node.js 앱으로 보내지 않았기 때문에 서버 시작시 남긴 로그 한줄만 표시됨

### 컨테이너 이름을 지정해 다중 컨테이너 파드에서 로그 가져오기

여러 컨테이너를 포함한 파드의 경우

- 컨테이너 이름을 kubectl logs 명령에 `-c <컨테이너 이름>` 옵션과 함께 명시적으로 포함해야함

다른 컨테이너가 존재한다면 로그를 가져오기 위해 이런 명령을 사용해야함

```bash
kubectl logs kubia-manual -c kubia
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled%201.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled%201.png)

## 5. 파드에 요청 보내기

파드가 실행중일때, 어떻게 해야 파드의 실제 동작을 볼 수 있을까?

> 포트 포워딩을 이용하자

### 로컬 네트워크 포트를 파드의 포트로 포워딩

서비스를 거치지 않고 (디버깅이나 다른 이유로) 특정 파드와 대화하고 싶을때

- 쿠버네티스 : 해당 파드로 향하는 포트 포워딩을 구성해준다
- 포트 포워딩 구성 명령

```bash
kubectl port-forward kubia-manual 8888:8080
```

>>> 머신의 로컬포트 8888을 kubia-manual 파드의 8080포트로 향하게 한다

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled%202.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/Untitled%202.png)

>>>> 포트 포워딩이 실행돼 이제 로컬 포트로 파드에 연결 가능

### 포트 포워딩을 통해 파드 연결

다른 터미널에서 `curl`로 `localhost:8888`에서 실행되고 있는 `kubectl port-forward` 프록시를 통해 HTTP 요청을 해당 파드에 보내보자

```bash
curl localhost:8888
```

![3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.32.42.png](3%202%20Yaml%20%E1%84%84%E1%85%A9%E1%84%82%E1%85%B3%E1%86%AB%20JSON%20%E1%84%83%E1%85%B5%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%B8%E1%84%90%E1%85%A5%E1%84%85%E1%85%A9%20%E1%84%91%E1%85%A1%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%206aea6b62add34f069dda0f3b5174c1de/_2021-03-20__3.32.42.png)

>>> 이걸로 개별 파드를 효과적으로 테스팅 가능